<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facturador CR Prototipo</title>
    <!-- Carga Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Estilos personalizados para la fuente Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* gris claro */
        }
        /* Estilo para el link activo de la barra lateral */
        .nav-link.active {
            background-color: #4a5568; /* gris más oscuro */
            color: white;
            font-weight: 600;
        }
        /* Estilos para el scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }
        
        /* --- ESTILOS SIMPLIFICADOS (SIN COLAPSO) --- */
        .nav-text {
            white-space: nowrap; 
            margin-left: 0.75rem; /* ml-3 */
        }

        /* Asegurar que el header de la tabla sea pegajoso */
        .sticky-header thead th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- ===== BARRA LATERAL (SIDEBAR) ===== -->
    <aside id="sidebar" class="w-64 bg-gray-800 text-gray-200 flex flex-col" style="height: 100vh; position: fixed; top: 0; left: 0; z-index: 40;">
        <div class="px-6 py-5">
            <h1 id="sidebar-title" class="text-2xl font-bold text-white">Factura<span class="text-blue-400">Pyme</span></h1>
        </div>
        <nav class="flex-1 px-4 py-2 space-y-2 overflow-y-auto">
            <ul class="space-y-2">
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="dashboard">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25A2.25 2.25 0 0113.5 8.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="facturacion">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span class="nav-text">Facturación</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="clientes">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
                        <span class="nav-text">Clientes</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="productos">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25m9-5.25v9l-9 5.25M3 7.5l9 5.25M3 7.5v9l9 5.25m0-9v9" /></svg>
                        <span class="nav-text">Productos</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="documentos">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                        <span class="nav-text">Documentos</span>
                    </a>
                </li>
                <!-- Nuevos links -->
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="contable">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" ><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.05a2.25 2.25 0 01-2.25 2.25h-13.5a2.25 2.25 0 01-2.25-2.25v-4.05M20.25 14.15v-4.05a2.25 2.25 0 00-2.25-2.25h-13.5a2.25 2.25 0 00-2.25 2.25v4.05m18-4.05v-4.05a2.25 2.25 0 00-2.25-2.25h-13.5a2.25 2.25 0 00-2.25 2.25v4.05m18 0v4.05a2.25 2.25 0 01-2.25 2.25h-13.5a2.25 2.25 0 01-2.25-2.25v-4.05m13.5 0v-4.05a2.25 2.25 0 00-2.25-2.25h-4.5a2.25 2.25 0 00-2.25 2.25v4.05m0 0v4.05a2.25 2.25 0 002.25 2.25h4.5a2.25 2.25 0 002.25-2.25v-4.05m-4.5 0h4.5" /></svg>
                        <span class="nav-text">Contable</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="nav-link flex items-center px-4 py-3 rounded-lg hover:bg-gray-700 justify-start" data-page="settings">
                        <svg class="w-5 h-5 flex-shrink-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-1.007 1.11-1.227a1.99 1.99 0 012.086.064c.37.24.706.558 1.002.93a1.99 1.99 0 01.344 2.296c-.228.42-.16.94-.058 1.35c.102.41.28.794.51 1.13c.23.335.53.61.87.81c.34.2.71.326 1.09.37c.38.045.75.14 1.1.29c.35.15.68.36 1 .63c.32.27.59.6.79 1c.2.4.3.84.3 1.31c0 .47-.1.91-.3 1.31c-.2.4-.47.73-.79 1c-.32.27-.65.48-1 .63c-.35.15-.72.245-1.1.29c-.38.045-.71.17-1.09.37c-.34.2-.64.475-.87.81c-.23.335-.41.72-.51 1.13c-.1.41-.17.93.06 1.35c.22.42.15.95-.19 1.32c-.34.37-.77.64-1.23.8c-.46.16-1 .16-1.46 0c-.46-.16-.89-.43-1.23-.8c-.34-.37-.41-.9-.19-1.32c.22-.42.16-.94.06-1.35c-.1-.41-.28-.795-.51-1.13c-.23-.335-.53-.61-.87-.81c-.34-.2-.71-.325-1.09-.37c-.38-.045-.75-.14-1.1-.29c-.35-.15-.68-.36-1-.63c-.32.27-.59-.6.79-1c-.2-.4-.3-.84-.3-1.31c0-.47.1-.91.3-1.31c.2-.4.47-.73.79 1c.32.27.65.48-1 .63c.35-.15.72-.245-1.1-.29c-.38.045-.71-.17-1.09.37c-.34.2-.64.475-.87.81c-.23-.335-.41-.72-.51 1.13c-.102-.41-.17-.93-.058-1.35C5.06 6.23 5.13 5.7 5.36 5.28c.34-.62.78-1.14 1.32-1.52c.54-.38 1.15-.59 1.78-.62c.63-.03 1.24.13 1.78.48c.54.35 1 .87 1.32 1.52c.23.42.29.95.06 1.35c-.1-.41-.28-.795-.51-1.13c-.23-.335-.53-.61-.87-.81c-.34-.2-.71-.325-1.09-.37c-.38-.045-.75-.14-1.1-.29c-.35-.15-.68-.36-1-.63c-.32-.27-.59-.6-.79-1c-.2-.4-.3-.84-.3-1.31zM12 15.75a3.75 3.75 0 100-7.5 3.75 3.75 0 000 7.5z" clip-rule="evenodd" /></svg>
                        <span class="nav-text">Settings</span>
                    </a>
                </li>
            </ul>
        </nav>
        <!-- Botón para colapsar ELIMINADO -->
    </aside>

    <!-- ===== CONTENIDO PRINCIPAL (MAIN) ===== -->
    <main class="flex-1 overflow-y-auto p-8 lg:p-10 ml-64" style="height: 100vh;">
        
        <!-- ===== PÁGINA: DASHBOARD (HUB) ===== -->
        <div id="page-dashboard" class="page-container">
            <!-- Encabezado -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">Dashboard</h2>
            </div>
            
            <!-- KPIs (Indicadores Clave) -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-green-500">
                    <h3 class="text-sm font-medium text-gray-500">Ingresos del Mes (Facturado)</h3>
                    <p class="text-3xl font-bold text-gray-800" id="kpi-ingresos">--</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-yellow-500">
                    <h3 class="text-sm font-medium text-gray-500">Cuentas por Cobrar (Pendiente)</h3>
                    <p class="text-3xl font-bold text-gray-800" id="kpi-por-cobrar">--</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border-l-4 border-red-500">
                    <h3 class="text-sm font-medium text-gray-500">Egresos del Mes (Gastos)</h3>
                    <p class="text-3xl font-bold text-gray-800" id="kpi-egresos">--</p>
                </div>
            </div>

            <!-- Gráficos Principales -->
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
                <!-- Gráfico de Ingresos vs Egresos -->
                <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Ingresos vs. Egresos (Últimos 6 Meses)</h3>
                    <div class="h-64">
                        <canvas id="salesChart"></canvas>
                    </div>
                </div>
                <!-- Estadísticas Clave -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Mejor Cliente del Mes</h3>
                        <div class="flex items-center space-x-3">
                            <span class="flex items-center justify-center w-10 h-10 rounded-full bg-blue-100 text-blue-600 font-bold" id="mejor-cliente-inicial">--</span>
                            <div>
                                <p class="font-medium text-gray-800" id="mejor-cliente-nombre">--</p>
                                <p class="text-sm text-gray-500" id="mejor-cliente-total">--</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700 mb-2">Producto Más Vendido</h3>
                        <p class="font-medium text-gray-800" id="mejor-producto">--</p>
                        <p class="text-sm text-gray-500" id="mejor-producto-unidades">--</p>
                    </div>
                </div>
            </div>

            <!-- Gráfico de Tendencia y Facturas Recientes -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- Gráfico de Tendencia Semanal -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Tendencia de Ventas (Últimas 4 Semanas)</h3>
                    <div class="h-64">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <!-- Facturas Recientes -->
                <div class="bg-white rounded-lg shadow-md flex flex-col">
                    <h3 class="text-lg font-semibold text-gray-700 p-4">Facturas Recientes</h3>
                    <!-- Contenedor con scroll vertical -->
                    <div class="flex-grow overflow-y-auto" style="max-height: 250px;">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                    <th scope="col" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200" id="recent-invoices-body">
                                <!-- Filas de facturas se insertarán aquí -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== PÁGINA: FACTURACIÓN ===== -->
        <div id="page-facturacion" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Nueva Factura Electrónica</h2>
            <form id="invoice-form" class="space-y-8">
                
                <!-- Sección Cliente -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">1. Cliente</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="invoice-client" class="block text-sm font-medium text-gray-700">Seleccionar Cliente</label>
                            <div class="flex space-x-2">
                                <select id="invoice-client" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="">Seleccione un cliente...</option>
                                </select>
                                <button type="button" id="add-client-btn" class="mt-1 px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors flex items-center">
                                    <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                                    Agregar
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Información</label>
                            <div id="client-info" class="mt-1 p-3 bg-gray-50 rounded-md min-h-[42px] text-sm text-gray-600">
                                <!-- Info del cliente aparecerá aquí -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sección Líneas de Factura -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">2. Productos / Servicios</h3>
                    <div class="space-y-4">
                        <!-- Contenedor de líneas de factura -->
                        <div id="invoice-items-container" class="space-y-3">
                            <!-- La primera línea se agrega por JS -->
                        </div>
                        <!-- Botón para agregar línea -->
                        <button type="button" id="add-invoice-item" class="text-blue-600 hover:text-blue-800 font-medium text-sm flex items-center">
                            <svg class="w-4 h-4 mr-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Agregar Línea
                        </button>
                    </div>
                </div>

                <!-- Sección Totales y Envío -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Totales -->
                    <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">3. Totales</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-gray-600">
                                <span>Subtotal:</span>
                                <span id="total-subtotal">₡0.00</span>
                            </div>
                            <div class="flex justify-between text-gray-600">
                                <span>IVA (13%):</span>
                                <span id="total-iva">₡0.00</span>
                            </div>
                            <div class="flex justify-between text-2xl font-bold text-gray-800 border-t pt-3">
                                <span>Total:</span>
                                <span id="total-general">₡0.00</span>
                            </div>
                        </div>
                    </div>
                    <!-- Acciones -->
                    <div class="bg-white p-6 rounded-lg shadow-md flex flex-col justify-between">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">4. Enviar</h3>
                        <div class="space-y-3">
                            <button type="button" id="send-proforma-btn" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg shadow-md font-semibold hover:bg-green-700 transition-colors flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                Crear Proforma
                            </button>
                            <button type="submit" id="send-invoice-btn" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg shadow-md font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.875L6 12z" /></svg>
                                Enviar a Hacienda
                            </button>
                            <button type="button" id="save-draft-btn" class="w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition-colors">
                                Guardar Borrador
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ===== PÁGINA: CLIENTES ===== -->
        <div id="page-clientes" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Gestión de Clientes</h2>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <!-- Barra de herramientas -->
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
                    <button id="add-client-page-btn" class="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Agregar Nuevo Cliente
                    </button>
                    <div class="w-full sm:w-64">
                        <input type="text" id="client-search" placeholder="Buscar por nombre o cédula..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cédula</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correo</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teléfono</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="clientes-table-body">
                        <!-- Los datos se insertarán aquí desde la DB simulada -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== PÁGINA: PRODUCTOS ===== -->
        <div id="page-productos" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Gestión de Productos y Servicios</h2>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <!-- Barra de herramientas -->
                <div class="mb-6">
                    <button id="add-product-btn" class="flex items-center bg-green-600 text-white px-4 py-2 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                        <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                        Agregar Nuevo Producto
                    </button>
                </div>
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CABYS</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IVA</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="productos-table-body">
                        <!-- Los datos se insertarán aquí desde la DB simulada -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- ===== PÁGINA: EGRESOS ===== -->
        <div id="page-egresos" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Gestión de Egresos (Gastos)</h2>
            <div class="bg-white p-8 rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Proveedor</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Concepto</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="egresos-table-body">
                        <!-- Los datos se insertarán aquí desde la DB simulada -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- ===== PÁGINA: DOCUMENTOS ===== -->
        <div id="page-documentos" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Documentos</h2>
            
            <!-- Tiles de Tipos de Documentos -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer documento-tile" data-tipo="emitidos">
                    <div class="flex items-center justify-center mb-4">
                        <svg class="w-12 h-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 text-center">Emitidos</h3>
                    <p class="text-sm text-gray-500 text-center mt-2">Facturas electrónicas emitidas</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer documento-tile" data-tipo="proformas">
                    <div class="flex items-center justify-center mb-4">
                        <svg class="w-12 h-12 text-green-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 text-center">Proformas</h3>
                    <p class="text-sm text-gray-500 text-center mt-2">Cotizaciones y presupuestos</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer documento-tile" data-tipo="descargar">
                    <div class="flex items-center justify-center mb-4">
                        <svg class="w-12 h-12 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 text-center">Descargar Documentos</h3>
                    <p class="text-sm text-gray-500 text-center mt-2">Exportar por fechas</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-lg transition-shadow cursor-pointer documento-tile" data-tipo="migracion">
                    <div class="flex items-center justify-center mb-4">
                        <svg class="w-12 h-12 text-orange-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 3v1.5M4.5 8.25H3m18 0h-1.5M4.5 12H3m18 0h-1.5m-16.5 3.75H3m18 0h-1.5M8.25 19.5v1.5m7.5-1.5v1.5m-7.5-7.5h1.5m5.25 0h1.5m-1.5-6h1.5m-7.5 6h1.5M12 4.5a7.5 7.5 0 100 15 7.5 7.5 0 000-15z" /></svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-700 text-center">Migración</h3>
                    <p class="text-sm text-gray-500 text-center mt-2">Transferencia de datos</p>
                </div>
            </div>
            
            <!-- Información de Documentos -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-700 mb-4" id="documentos-titulo">Selecciona un tipo de documento</h3>
                <div id="documentos-contenido">
                    <p class="text-gray-500">Haz click en uno de los tiles arriba para ver la información correspondiente.</p>
                </div>
            </div>
        </div>

        <!-- ===== PÁGINA: CONTABLE (NUEVA) ===== -->
        <div id="page-contable" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Módulo Contable</h2>
            <div class="bg-white p-10 rounded-lg shadow-md text-center">
                <h3 class="text-xl font-semibold text-gray-700">Próximamente</h3>
                <p class="text-gray-500 mt-2">Aquí se mostrarán reportes contables, conciliación y exportaciones para el contador.</p>
            </div>
        </div>

        <!-- ===== PÁGINA: SETTINGS (NUEVA) ===== -->
        <div id="page-settings" class="page-container hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Configuración</h2>
            <div class="bg-white p-10 rounded-lg shadow-md text-center">
                <h3 class="text-xl font-semibold text-gray-700">Próximamente</h3>
                <p class="text-gray-500 mt-2">Aquí irán los datos de la empresa, configuración de impuestos, usuarios y más.</p>
            </div>
        </div>

    </main>

    <!-- ===== MODAL DE NOTIFICACIÓN ===== -->
    <div id="notification-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <h3 id="notification-title" class="text-lg font-medium text-gray-900">Notificación</h3>
            <div class="mt-2">
                <p id="notification-message" class="text-sm text-gray-500">Mensaje.</p>
            </div>
            <div id="notification-spinner" class="hidden my-4 text-center">
                <div class="inline-block h-8 w-8 animate-spin rounded-full border-4 border-solid border-blue-500 border-r-transparent align-[-0.125em] motion-reduce:animate-[spin_1.5s_linear_infinite]" role="status">
                    <span class="!absolute !-m-px !h-px !w-px !overflow-hidden !whitespace-nowrap !border-0 !p-0 ![clip:rect(0,0,0,0)]">Cargando...</span>
                </div>
            </div>
            <div class="mt-4 text-right">
                <button id="notification-close-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                    Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- ===== MODAL AGREGAR CLIENTE ===== -->
    <div id="add-client-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Agregar Nuevo Cliente</h3>
                <button id="add-client-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="add-client-form" class="space-y-4">
                <div>
                    <label for="client-nombre" class="block text-sm font-medium text-gray-700">Nombre Completo</label>
                    <input type="text" id="client-nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="client-cedula" class="block text-sm font-medium text-gray-700">Cédula</label>
                    <input type="text" id="client-cedula" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="client-email" class="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                    <input type="email" id="client-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="client-telefono" class="block text-sm font-medium text-gray-700">Teléfono</label>
                    <input type="tel" id="client-telefono" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-client-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Guardar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===== MODAL AGREGAR PRODUCTO ===== -->
    <div id="add-product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Agregar Nuevo Producto</h3>
                <button id="add-product-close-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="add-product-form" class="space-y-4">
                <div>
                    <label for="product-nombre" class="block text-sm font-medium text-gray-700">Nombre del Producto/Servicio</label>
                    <input type="text" id="product-nombre" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="product-precio" class="block text-sm font-medium text-gray-700">Precio</label>
                    <input type="number" id="product-precio" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="product-cabys" class="block text-sm font-medium text-gray-700">Código CABYS</label>
                    <input type="text" id="product-cabys" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="product-iva" class="block text-sm font-medium text-gray-700">IVA (%)</label>
                    <select id="product-iva" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        <option value="0.13">13% (General)</option>
                        <option value="0.0">0% (Exento)</option>
                        <option value="0.04">4% (Reducido)</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="add-product-cancel-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">
                        Cancelar
                    </button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                        Guardar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- ===== SCRIPT PRINCIPAL ===== -->
    <script>
        // --- BASE DE DATOS SIMULADA ---
        // Simulación de una base de datos de pyme
        const db = {
            clientes: [
                { id: 1, nombre: "Constructora El Roble S.A.", cedula: "3-101-123456", email: "facturacion@roble.cr", telefono: "2233-4455" },
                { id: 2, nombre: "Ana Sofía Vargas (Serv. Profesionales)", cedula: "1-1234-5678", email: "ana.vargas@gmail.com", telefono: "8899-0011" },
                { id: 3, nombre: "Supermercado La Familia", cedula: "3-101-789012", email: "contabilidad@lafamilia.cr", telefono: "2567-8901" }
            ],
            productos: [
                { id: 101, nombre: "Servicio de Consultoría (Hora)", precio: 45000, cabys: "7210001", iva: 0.13 },
                { id: 102, nombre: "Diseño de Logo Corporativo", precio: 250000, cabys: "8212001", iva: 0.13 },
                { id: 103, nombre: "Licencia de Software (Mensual)", precio: 15000, cabys: "5820001", iva: 0.13 },
                { id: 104, nombre: "Capacitación (Exenta)", precio: 100000, cabys: "8630001", iva: 0.0 }
            ],
            facturas: [
                { id: 2024001, clienteId: 1, fecha: "2024-10-28", total: 50850, estado: "Pagada", lineas: [{ productoId: 101, cantidad: 1, precio: 45000 }] },
                { id: 2024002, clienteId: 2, fecha: "2024-10-15", total: 282500, estado: "Pagada", lineas: [{ productoId: 102, cantidad: 1, precio: 250000 }] },
                { id: 2024003, clienteId: 3, fecha: "2024-11-01", total: 33900, estado: "Pendiente", lineas: [{ productoId: 103, cantidad: 2, precio: 15000 }] },
                { id: 2024004, clienteId: 1, fecha: "2024-11-05", total: 100000, estado: "Pendiente", lineas: [{ productoId: 104, cantidad: 1, precio: 100000 }] },
                { id: 2024005, clienteId: 2, fecha: "2024-09-20", total: 50850, estado: "Vencida", lineas: [{ productoId: 101, cantidad: 1, precio: 45000 }] },
                { id: 2024006, clienteId: 1, fecha: "2024-11-08", total: 50850, estado: "Pendiente", lineas: [{ productoId: 101, cantidad: 1, precio: 45000 }] }
            ],
            egresos: [
                { id: 1, fecha: "2024-11-01", proveedor: "ICE", concepto: "Recibo Eléctrico", monto: 42000 },
                { id: 2, fecha: "2024-11-03", proveedor: "OfiCentro", concepto: "Suministros de oficina", monto: 25000 },
                { id: 3, fecha: "2024-11-05", proveedor: "Google Ads", concepto: "Publicidad", monto: 75000 }
            ],
            borradores: [],
            statsMensuales: {
                labels: ["Jun", "Jul", "Ago", "Sep", "Oct", "Nov"],
                ingresos: [1500000, 1800000, 1750000, 2100000, 2400000, 1500000],
                egresos: [800000, 950000, 900000, 1100000, 1200000, 450000]
            },
            statsSemanales: {
                labels: ["Sem 42", "Sem 43", "Sem 44", "Sem 45"],
                ventas: [350000, 420000, 380000, 510000]
            }
        };

        // --- UTILIDADES ---
        const formatCurrency = (value) => new Intl.NumberFormat('es-CR', { style: 'currency', currency: 'CRC' }).format(value);

        // --- LÓGICA DE LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {

            const pages = document.querySelectorAll('.page-container');
            const navLinks = document.querySelectorAll('.nav-link');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.querySelector('main');
            
            // --- LÓGICA DE COLAPSO ELIMINADA ---
            // const toggleBtn = document.getElementById('sidebar-toggle-btn');
            // const toggleBtnText = toggleBtn.querySelector('.nav-text');
            // const toggleBtnIcon = document.getElementById('sidebar-toggle-icon');




            // --- LÓGICA DE NAVEGACIÓN ---
            function showPage(pageId) {
                // Ocultar todas las páginas
                pages.forEach(page => page.classList.add('hidden'));
                
                // Mostrar la página solicitada
                const targetPage = document.getElementById(`page-${pageId}`);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }

                // Actualizar el estado activo de los links
                navLinks.forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.page === pageId) {
                        link.classList.add('active');
                    }
                });

                // Cargar datos en la página
                switch (pageId) {
                    case 'dashboard': renderDashboard(); break;
                    case 'facturacion': renderInvoiceForm(); break;
                    case 'clientes': renderClientes(); break;
                    case 'productos': renderProductos(); break;
                    case 'egresos': renderEgresos(); break;
                    case 'documentos': /* Inicializar vacío */ break;
                    case 'contable': /* No hay render aún */ break;
                    case 'settings': /* No hay render aún */ break;
                }
            }

            // Navegación al hacer clic en los links
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.dataset.page;
                    showPage(pageId);
                });
            });

            // --- LÓGICA DE COLAPSO DEL SIDEBAR (ELIMINADA) ---
            // toggleBtn.addEventListener('click', () => { ... });
            // sidebar.addEventListener('transitionend', (event) => { ... });


            // --- LÓGICA DE RENDERIZADO DE PÁGINAS ---

            // RENDER DASHBOARD
            function renderDashboard() {
                // 1. KPIs
                const ingresos = db.facturas
                    .filter(f => f.estado === 'Pagada' && new Date(f.fecha).getMonth() === new Date().getMonth())
                    .reduce((acc, f) => acc + f.total, 0);
                
                const porCobrar = db.facturas
                    .filter(f => f.estado === 'Pendiente' || f.estado === 'Vencida')
                    .reduce((acc, f) => acc + f.total, 0);

                const egresos = db.egresos
                    .filter(e => new Date(e.fecha).getMonth() === new Date().getMonth())
                    .reduce((acc, e) => acc + e.monto, 0);

                document.getElementById('kpi-ingresos').textContent = formatCurrency(db.statsMensuales.ingresos.slice(-1)[0]);
                document.getElementById('kpi-por-cobrar').textContent = formatCurrency(porCobrar);
                document.getElementById('kpi-egresos').textContent = formatCurrency(db.statsMensuales.egresos.slice(-1)[0]);

                // 2. Mejor Cliente
                const ventasPorCliente = db.facturas.reduce((acc, f) => {
                    acc[f.clienteId] = (acc[f.clienteId] || 0) + f.total;
                    return acc;
                }, {});
                
                const mejorClienteId = Object.keys(ventasPorCliente).sort((a, b) => ventasPorCliente[b] - ventasPorCliente[a])[0];
                const mejorCliente = db.clientes.find(c => c.id == mejorClienteId);
                
                document.getElementById('mejor-cliente-nombre').textContent = mejorCliente.nombre;
                document.getElementById('mejor-cliente-total').textContent = `Facturado: ${formatCurrency(ventasPorCliente[mejorClienteId])}`;
                document.getElementById('mejor-cliente-inicial').textContent = mejorCliente.nombre.substring(0, 1);

                // 3. Mejor Producto
                const ventasPorProducto = db.facturas
                    .flatMap(f => f.lineas)
                    .reduce((acc, l) => {
                        acc[l.productoId] = (acc[l.productoId] || 0) + l.cantidad;
                        return acc;
                    }, {});

                const mejorProductoId = Object.keys(ventasPorProducto).sort((a, b) => ventasPorProducto[b] - ventasPorProducto[a])[0];
                const mejorProducto = db.productos.find(p => p.id == mejorProductoId);

                document.getElementById('mejor-producto').textContent = mejorProducto.nombre;
                document.getElementById('mejor-producto-unidades').textContent = `${ventasPorProducto[mejorProductoId]} unidades vendidas`;

                // 4. Facturas Recientes
                const recentInvoicesBody = document.getElementById('recent-invoices-body');
                recentInvoicesBody.innerHTML = '';
                db.facturas.slice(0, 5).forEach(factura => {
                    const cliente = db.clientes.find(c => c.id === factura.clienteId);
                    let estadoClass = '';
                    if (factura.estado === 'Pagada') estadoClass = 'bg-green-100 text-green-800';
                    else if (factura.estado === 'Pendiente') estadoClass = 'bg-yellow-100 text-yellow-800';
                    else if (factura.estado === 'Vencida') estadoClass = 'bg-red-100 text-red-800';

                    const row = `
                        <tr>
                            <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-800">${cliente.nombre}</td>
                            <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-600">${formatCurrency(factura.total)}</td>
                            <td class="px-4 py-2 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${estadoClass}">
                                    ${factura.estado}
                                </span>
                            </td>
                        </tr>
                    `;
                    recentInvoicesBody.innerHTML += row;
                });
                
                // 5. Gráficos
                initDashboardCharts();
            }

            // INICIALIZAR GRÁFICOS
            // Esta función es llamada por renderDashboard y por el 'transitionend'
            function initDashboardCharts() {
                // Destruir gráficos existentes para evitar conflictos
                // CORRECCIÓN: Comprobar si la variable global es una instancia de Chart.
                // El 'if (window.salesChart)' simple da un falso positivo porque
                // el navegador crea una variable global window.salesChart para el <canvas> con id="salesChart".
                if (window.salesChart instanceof Chart) {
                    window.salesChart.destroy();
                }
                if (window.trendChart instanceof Chart) {
                    window.trendChart.destroy();
                }

                // Gráfico 1: Ingresos vs Egresos
                const ctxSales = document.getElementById('salesChart').getContext('2d');
                window.salesChart = new Chart(ctxSales, {
                    type: 'bar',
                    data: {
                        labels: db.statsMensuales.labels,
                        datasets: [
                            {
                                label: 'Ingresos',
                                data: db.statsMensuales.ingresos,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)', // blue-500
                                borderRadius: 4,
                            },
                            {
                                label: 'Egresos',
                                data: db.statsMensuales.egresos,
                                backgroundColor: 'rgba(239, 68, 68, 0.8)', // red-500
                                borderRadius: 4,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: (value) => `₡${value/1000}K` } },
                            x: { grid: { display: false } }
                        },
                        plugins: { legend: { position: 'top', align: 'end' } },
                        interaction: { intersect: false, mode: 'index' }
                    }
                });

                // Gráfico 2: Tendencia Semanal
                const ctxTrend = document.getElementById('trendChart').getContext('2d');
                window.trendChart = new Chart(ctxTrend, {
                    type: 'line',
                    data: {
                        labels: db.statsSemanales.labels,
                        datasets: [{
                            label: 'Ventas',
                            data: db.statsSemanales.ventas,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderColor: 'rgba(59, 130, 246, 1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { callback: (value) => `₡${value/1000}K` } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }

            // RENDER CLIENTES
            function renderClientes(filterText = '') {
                const tableBody = document.getElementById('clientes-table-body');
                tableBody.innerHTML = '';
                
                const filteredClientes = db.clientes.filter(cliente => {
                    const searchLower = filterText.toLowerCase();
                    return cliente.nombre.toLowerCase().includes(searchLower) || 
                           cliente.cedula.toLowerCase().includes(searchLower);
                });
                
                filteredClientes.forEach(cliente => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cliente.nombre}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.cedula}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.email}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.telefono}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            // RENDER PRODUCTOS
            function renderProductos() {
                const tableBody = document.getElementById('productos-table-body');
                tableBody.innerHTML = '';
                db.productos.forEach(prod => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${prod.nombre}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(prod.precio)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${prod.cabys}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${prod.iva * 100}%</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }
            
            // RENDER EGRESOS
            function renderEgresos() {
                const tableBody = document.getElementById('egresos-table-body');
                tableBody.innerHTML = '';
                db.egresos.forEach(egreso => {
                    const row = `
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${egreso.fecha}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${egreso.proveedor}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${egreso.concepto}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(egreso.monto)}</td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            }

            // RENDER DOCUMENTOS CONTENIDO
            function renderDocumentosContenido(tipo) {
                const titulo = document.getElementById('documentos-titulo');
                const contenido = document.getElementById('documentos-contenido');
                
                titulo.textContent = tipo.charAt(0).toUpperCase() + tipo.slice(1);
                
                if (tipo === 'emitidos') {
                    // Mostrar tabla de facturas emitidas
                    contenido.innerHTML = `
                        <div class="overflow-y-auto" style="max-height: 400px;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Número</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monto</th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${db.facturas.map(factura => {
                                        const cliente = db.clientes.find(c => c.id === factura.clienteId);
                                        let estadoClass = '';
                                        if (factura.estado === 'Pagada') estadoClass = 'bg-green-100 text-green-800';
                                        else if (factura.estado === 'Pendiente') estadoClass = 'bg-yellow-100 text-yellow-800';
                                        else if (factura.estado === 'Vencida') estadoClass = 'bg-red-100 text-red-800';
                                        return `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${factura.id}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${factura.fecha}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente.nombre}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${formatCurrency(factura.total)}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${estadoClass}">
                                                        ${factura.estado}
                                                    </span>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                } else if (tipo === 'descargar') {
                    // Mostrar formulario para descargar
                    contenido.innerHTML = `
                        <form id="descargar-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="fecha-desde" class="block text-sm font-medium text-gray-700">Fecha Desde</label>
                                    <input type="date" id="fecha-desde" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label for="fecha-hasta" class="block text-sm font-medium text-gray-700">Fecha Hasta</label>
                                    <input type="date" id="fecha-hasta" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                </div>
                            </div>
                            <div>
                                <label for="tipo-documento" class="block text-sm font-medium text-gray-700">Tipo de Documento</label>
                                <select id="tipo-documento" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <option value="todos">Todos</option>
                                    <option value="facturas">Facturas</option>
                                    <option value="recibos">Recibos</option>
                                </select>
                            </div>
                            <div class="flex justify-end">
                                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                                    Descargar Documentos
                                </button>
                            </div>
                        </form>
                    `;
                    // Event listener para el formulario
                    document.getElementById('descargar-form').addEventListener('submit', (e) => {
                        e.preventDefault();
                        const desde = document.getElementById('fecha-desde').value;
                        const hasta = document.getElementById('fecha-hasta').value;
                        const tipoDoc = document.getElementById('tipo-documento').value;
                        showNotification(`Descargando documentos desde ${desde} hasta ${hasta} (${tipoDoc})`, "Procesando");
                        // Simulación de descarga
                        setTimeout(() => {
                            showNotification("Documentos descargados exitosamente.", "Éxito");
                        }, 2000);
                    });
                } else if (tipo === 'proformas') {
                    // Mostrar tabla de proformas y borradores
                    const proformasYBorradores = db.borradores.filter(b => b.tipo === 'proforma' || b.tipo === 'borrador');
                    if (proformasYBorradores.length === 0) {
                        contenido.innerHTML = '<p class="text-gray-500">No hay proformas o borradores guardados.</p>';
                    } else {
                        contenido.innerHTML = `
                            <div class="overflow-y-auto" style="max-height: 400px;">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cliente</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        ${proformasYBorradores.map(borrador => {
                                            const cliente = db.clientes.find(c => c.id === borrador.clienteId);
                                            return `
                                                <tr>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${borrador.tipo.charAt(0).toUpperCase() + borrador.tipo.slice(1)}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${borrador.fecha}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${cliente ? cliente.nombre : 'N/A'}</td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <button class="text-blue-600 hover:text-blue-800 mr-2" onclick="cargarBorrador(${borrador.id})">Cargar</button>
                                                        <button class="text-red-600 hover:text-red-800" onclick="eliminarBorrador(${borrador.id})">Eliminar</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                } else {
                    contenido.innerHTML = '<p class="text-gray-500">Selecciona un tipo de documento.</p>';
                }
            }

            // Funciones globales para borradores
            window.cargarBorrador = (id) => {
                const borrador = db.borradores.find(b => b.id === id);
                if (!borrador) return;
                
                // Cambiar a página de facturación
                showPage('facturacion');
                
                // Cargar datos
                document.getElementById('invoice-client').value = borrador.clienteId;
                document.getElementById('invoice-client').dispatchEvent(new Event('change'));
                
                // Limpiar líneas existentes
                document.getElementById('invoice-items-container').innerHTML = '';
                
                // Agregar líneas
                borrador.lineas.forEach(linea => {
                    addInvoiceItem();
                    const rows = document.querySelectorAll('.invoice-item-row');
                    const lastRow = rows[rows.length - 1];
                    lastRow.querySelector('.invoice-item-product').value = linea.productoId;
                    lastRow.querySelector('.invoice-item-product').dispatchEvent(new Event('change'));
                    lastRow.querySelector('.invoice-item-qty').value = linea.cantidad;
                    lastRow.querySelector('.invoice-item-qty').dispatchEvent(new Event('input'));
                });
                
                showNotification("Borrador cargado.", "Éxito");
            };
            
            window.eliminarBorrador = (id) => {
                db.borradores = db.borradores.filter(b => b.id !== id);
                renderDocumentosContenido('proformas');
                showNotification("Borrador eliminado.", "Éxito");
            };

            // RENDER FORMULARIO DE FACTURA
            let invoiceItemCounter = 0;
            function renderInvoiceForm() {
                // Llenar select de clientes
                const clientSelect = document.getElementById('invoice-client');
                clientSelect.innerHTML = '<option value="">Seleccione un cliente...</option>';
                db.clientes.forEach(cliente => {
                    clientSelect.innerHTML += `<option value="${cliente.id}">${cliente.nombre}</option>`;
                });
                
                // Resetear líneas
                invoiceItemCounter = 0;
                document.getElementById('invoice-items-container').innerHTML = '';
                addInvoiceItem(); // Agregar la primera línea

                // Resetear totales
                updateTotals();

                // Limpiar info de cliente
                document.getElementById('client-info').textContent = '';
            }

            // Lógica del formulario de factura
            document.getElementById('invoice-client').addEventListener('change', (e) => {
                const clientId = e.target.value;
                const clientInfoBox = document.getElementById('client-info');
                if (!clientId) {
                    clientInfoBox.textContent = '';
                    return;
                }
                const cliente = db.clientes.find(c => c.id == clientId);
                clientInfoBox.textContent = `Cédula: ${cliente.cedula} | Email: ${cliente.email}`;
            });

            document.getElementById('add-invoice-item').addEventListener('click', addInvoiceItem);
            
            function addInvoiceItem() {
                invoiceItemCounter++;
                const itemHtml = `
                    <div class="grid grid-cols-12 gap-x-4 gap-y-2 invoice-item-row" data-id="${invoiceItemCounter}">
                        <div class="col-span-12 md:col-span-6">
                            <label class="block text-sm font-medium text-gray-700">Producto/Servicio</label>
                            <select class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 invoice-item-product">
                                <option value="">Seleccione...</option>
                                ${db.productos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-span-4 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700">Cantidad</label>
                            <input type="number" value="1" min="1" class="invoice-item-qty mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="col-span-5 md:col-span-3">
                            <label class="block text-sm font-medium text-gray-700">Precio Unit.</label>
                            <input type="number" readonly class="invoice-item-price mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100">
                        </div>
                        <div class="col-span-3 md:col-span-1 flex items-end">
                            <button type="button" class="remove-invoice-item mt-1 text-red-500 hover:text-red-700 p-2 rounded-md">
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12.54 0c-.27.041-.54.082-.811.124m10.022 3.301c.378.02.75.034 1.12.034s.742-.014 1.12-.034m-3.005 0H9.005m5.418 0l.28.034m-3.56 0l-.28.034" /></svg>
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('invoice-items-container').insertAdjacentHTML('beforeend', itemHtml);
                
                // Asignar eventos a la nueva línea
                const newRow = document.querySelector(`.invoice-item-row[data-id="${invoiceItemCounter}"]`);
                newRow.querySelector('.invoice-item-product').addEventListener('change', updateLinePrice);
                newRow.querySelector('.invoice-item-qty').addEventListener('input', updateTotals);
                newRow.querySelector('.remove-invoice-item').addEventListener('click', removeInvoiceItem);
            }
            
            function updateLinePrice(e) {
                const productId = e.target.value;
                const row = e.target.closest('.invoice-item-row');
                const priceInput = row.querySelector('.invoice-item-price');
                if (!productId) {
                    priceInput.value = '';
                    updateTotals();
                    return;
                }
                const producto = db.productos.find(p => p.id == productId);
                priceInput.value = producto.precio;
                updateTotals();
            }

            function removeInvoiceItem(e) {
                const row = e.target.closest('.invoice-item-row');
                row.remove();
                updateTotals();
            }

            function updateTotals() {
                let subtotal = 0;
                let iva = 0;
                
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const productId = row.querySelector('.invoice-item-product').value;
                    const qty = parseFloat(row.querySelector('.invoice-item-qty').value) || 0;
                    const price = parseFloat(row.querySelector('.invoice-item-price').value) || 0;
                    
                    if (productId && qty > 0) {
                        const producto = db.productos.find(p => p.id == productId);
                        const lineSubtotal = price * qty;
                        const lineIva = lineSubtotal * producto.iva;
                        
                        subtotal += lineSubtotal;
                        iva += lineIva;
                    }
                });

                document.getElementById('total-subtotal').textContent = formatCurrency(subtotal);
                document.getElementById('total-iva').textContent = formatCurrency(iva);
                document.getElementById('total-general').textContent = formatCurrency(subtotal + iva);
            }
            
            // Re-asignar eventos que se pierden al cambiar de página
            document.getElementById('invoice-items-container').addEventListener('change', (e) => {
                if (e.target.classList.contains('invoice-item-product')) updateLinePrice(e);
            });
            document.getElementById('invoice-items-container').addEventListener('input', (e) => {
                if (e.target.classList.contains('invoice-item-qty')) updateTotals();
            });
            document.getElementById('invoice-items-container').addEventListener('click', (e) => {
                if (e.target.closest('.remove-invoice-item')) removeInvoiceItem(e);
            });

            // Enviar factura
            document.getElementById('invoice-form').addEventListener('submit', (e) => {
                e.preventDefault();
                
                const clientSelect = document.getElementById('invoice-client');
                if (!clientSelect.value) {
                    showNotification("Por favor, seleccione un cliente.", "Error");
                    clientSelect.classList.add('border-red-500', 'ring-red-500');
                    setTimeout(() => clientSelect.classList.remove('border-red-500', 'ring-red-500'), 2000);
                    return;
                }
                
                showNotification("Enviando a Hacienda...", "Procesando", true);
                
                // Simulación de API de Hacienda
                setTimeout(() => {
                    const total = document.getElementById('total-general').textContent;
                    const newInvoiceId = Math.floor(2024000 + Math.random() * 100);
                    
                    // Agregar a facturas
                    const clienteId = parseInt(clientSelect.value);
                    const lineas = [];
                    document.querySelectorAll('.invoice-item-row').forEach(row => {
                        const productId = parseInt(row.querySelector('.invoice-item-product').value);
                        const qty = parseFloat(row.querySelector('.invoice-item-qty').value);
                        const price = parseFloat(row.querySelector('.invoice-item-price').value);
                        if (productId && qty > 0) {
                            lineas.push({ productoId: productId, cantidad: qty, precio: price });
                        }
                    });
                    db.facturas.push({
                        id: newInvoiceId,
                        clienteId: clienteId,
                        fecha: new Date().toISOString().split('T')[0],
                        total: parseFloat(document.getElementById('total-general').textContent.replace('₡', '').replace(',', '')),
                        estado: 'Pendiente',
                        lineas: lineas
                    });
                    
                    showNotification(`Factura #${newInvoiceId} por ${total} enviada y aprobada por Hacienda.`, "Éxito");
                    showPage('dashboard');
                }, 2000);
            });

            // Guardar borrador
            document.getElementById('save-draft-btn').addEventListener('click', () => {
                const clientSelect = document.getElementById('invoice-client');
                if (!clientSelect.value) {
                    showNotification("Por favor, seleccione un cliente.", "Error");
                    return;
                }
                
                const draft = {
                    id: Date.now(), // Usar timestamp como ID único
                    clienteId: parseInt(clientSelect.value),
                    fecha: new Date().toISOString().split('T')[0],
                    lineas: [],
                    tipo: 'borrador'
                };
                
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const productId = parseInt(row.querySelector('.invoice-item-product').value);
                    const qty = parseFloat(row.querySelector('.invoice-item-qty').value);
                    const price = parseFloat(row.querySelector('.invoice-item-price').value);
                    if (productId && qty > 0) {
                        draft.lineas.push({ productoId: productId, cantidad: qty, precio: price });
                    }
                });
                
                db.borradores.push(draft);
                showNotification("Borrador guardado exitosamente.", "Éxito");
            });

            // Crear proforma
            document.getElementById('send-proforma-btn').addEventListener('click', () => {
                const clientSelect = document.getElementById('invoice-client');
                if (!clientSelect.value) {
                    showNotification("Por favor, seleccione un cliente.", "Error");
                    return;
                }
                
                const proforma = {
                    id: Date.now(),
                    clienteId: parseInt(clientSelect.value),
                    fecha: new Date().toISOString().split('T')[0],
                    lineas: [],
                    tipo: 'proforma'
                };
                
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const productId = parseInt(row.querySelector('.invoice-item-product').value);
                    const qty = parseFloat(row.querySelector('.invoice-item-qty').value);
                    const price = parseFloat(row.querySelector('.invoice-item-price').value);
                    if (productId && qty > 0) {
                        proforma.lineas.push({ productoId: productId, cantidad: qty, precio: price });
                    }
                });
                
                db.borradores.push(proforma);
                showNotification("Proforma creada exitosamente.", "Éxito");
            });


            // --- LÓGICA DE NOTIFICACIÓN (MODAL) ---
            const notificationModal = document.getElementById('notification-modal');
            const notificationTitle = document.getElementById('notification-title');
            const notificationMessage = document.getElementById('notification-message');
            const notificationSpinner = document.getElementById('notification-spinner');
            const notificationCloseBtn = document.getElementById('notification-close-btn');

            function showNotification(message, title, processing = false) {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                
                if (processing) {
                    notificationSpinner.style.display = 'block';
                    notificationCloseBtn.style.display = 'none';
                } else {
                    notificationSpinner.style.display = 'none';
                    notificationCloseBtn.style.display = 'block';
                }

                if (title === "Error") {
                    notificationTitle.classList.add('text-red-600');
                } else {
                    notificationTitle.classList.remove('text-red-600');
                }
                
                notificationModal.classList.remove('hidden');
            }

            notificationCloseBtn.addEventListener('click', () => {
                notificationModal.classList.add('hidden');
            });


            // --- LÓGICA MODAL AGREGAR CLIENTE ---
            const addClientModal = document.getElementById('add-client-modal');
            const addClientCloseBtn = document.getElementById('add-client-close-btn');
            const addClientCancelBtn = document.getElementById('add-client-cancel-btn');
            const addClientForm = document.getElementById('add-client-form');
            const addClientBtn = document.getElementById('add-client-btn');

            function showAddClientModal() {
                addClientModal.classList.remove('hidden');
                // Limpiar formulario
                addClientForm.reset();
            }

            function hideAddClientModal() {
                addClientModal.classList.add('hidden');
            }

            addClientBtn.addEventListener('click', showAddClientModal);
            addClientCloseBtn.addEventListener('click', hideAddClientModal);
            addClientCancelBtn.addEventListener('click', hideAddClientModal);

            addClientForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nombre = document.getElementById('client-nombre').value.trim();
                const cedula = document.getElementById('client-cedula').value.trim();
                const email = document.getElementById('client-email').value.trim();
                const telefono = document.getElementById('client-telefono').value.trim();
                
                // Validación básica
                if (!nombre || !cedula || !email || !telefono) {
                    showNotification("Por favor, complete todos los campos.", "Error");
                    return;
                }
                
                // Validar email básico
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showNotification("Por favor, ingrese un correo electrónico válido.", "Error");
                    return;
                }
                
                // Crear nuevo cliente
                const newId = Math.max(...db.clientes.map(c => c.id)) + 1;
                const newClient = {
                    id: newId,
                    nombre: nombre,
                    cedula: cedula,
                    email: email,
                    telefono: telefono
                };
                
                // Agregar a la base de datos
                db.clientes.push(newClient);
                
                // Actualizar el select de clientes en facturación
                const clientSelect = document.getElementById('invoice-client');
                clientSelect.innerHTML += `<option value="${newClient.id}">${newClient.nombre}</option>`;
                
                // Si estamos en la página de clientes, re-renderizar la tabla con el filtro actual
                if (!document.getElementById('page-clientes').classList.contains('hidden')) {
                    const currentFilter = document.getElementById('client-search').value;
                    renderClientes(currentFilter);
                }
                
                // Cerrar modal y mostrar notificación
                hideAddClientModal();
                showNotification(`Cliente "${newClient.nombre}" agregado exitosamente.`, "Éxito");
            });


            // --- LÓGICA MODAL AGREGAR PRODUCTO ---
            const addProductModal = document.getElementById('add-product-modal');
            const addProductCloseBtn = document.getElementById('add-product-close-btn');
            const addProductCancelBtn = document.getElementById('add-product-cancel-btn');
            const addProductForm = document.getElementById('add-product-form');
            const addProductBtn = document.getElementById('add-product-btn');

            function showAddProductModal() {
                addProductModal.classList.remove('hidden');
                // Limpiar formulario
                addProductForm.reset();
            }

            function hideAddProductModal() {
                addProductModal.classList.add('hidden');
            }

            addProductBtn.addEventListener('click', showAddProductModal);
            addProductCloseBtn.addEventListener('click', hideAddProductModal);
            addProductCancelBtn.addEventListener('click', hideAddProductModal);

            addProductForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                const nombre = document.getElementById('product-nombre').value.trim();
                const precio = parseFloat(document.getElementById('product-precio').value);
                const cabys = document.getElementById('product-cabys').value.trim();
                const iva = parseFloat(document.getElementById('product-iva').value);
                
                // Validación básica
                if (!nombre || isNaN(precio) || precio < 0 || !cabys) {
                    showNotification("Por favor, complete todos los campos correctamente.", "Error");
                    return;
                }
                
                // Crear nuevo producto
                const newId = Math.max(...db.productos.map(p => p.id)) + 1;
                const newProduct = {
                    id: newId,
                    nombre: nombre,
                    precio: precio,
                    cabys: cabys,
                    iva: iva
                };
                
                // Agregar a la base de datos
                db.productos.push(newProduct);
                
                // Actualizar el select de productos en facturación
                const productSelects = document.querySelectorAll('.invoice-item-product');
                productSelects.forEach(select => {
                    select.innerHTML += `<option value="${newProduct.id}">${newProduct.nombre}</option>`;
                });
                
                // Si estamos en la página de productos, re-renderizar la tabla
                if (!document.getElementById('page-productos').classList.contains('hidden')) {
                    renderProductos();
                }
                
                // Cerrar modal y mostrar notificación
                hideAddProductModal();
                showNotification(`Producto "${newProduct.nombre}" agregado exitosamente.`, "Éxito");
            });


            // --- INICIALIZACIÓN DE LA APP ---
            showPage('dashboard');
        });

    </script>
</body>
</html>